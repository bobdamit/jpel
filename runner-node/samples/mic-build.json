{
	"id": "mic-build",
	"name": "Microphone Build",
	"description": "Data Colleciton, QC and Task Lists for Microphone Builds",
	"version": "1.0.0",
	"start": "a:main",
	"variables": [
		{
			"name": "title",
			"type": "text",
			"description": "Title generated from common facts"
		}
	],
	"activities": {

		"main": {
			"name": "Main",
			"description": "Main Sequence",
			"type": "sequence",
			"activities": [
				"a:basicFactsSequence",
				"a:validateCommonFacts",
				"a:micTypeDecision",
				"a.visualInspectionSequence"
			]
		},


		"basicFactsSequence": {
			"name": "Basic Facts Sequency",
			"description": "Gather Data about the microphone build and compute a title",
			"type": "sequence",
			"activities": [
				"a:commonFacts",
				"a:generateTitle"
			]
		},
		"commonFacts": {
			"name": "Common Facts Collection",
			"description": "Collect common facts applicable to all microphone builds",
			"type": "human",
			"prompt": "Please provide the following common details for the microphone assembly:",
			"inputs": [
				{
					"name": "customerName",
					"type": "text",
					"label": "Customer Name",
					"required": true,
					"placeholder": "Enter customer name",
					"minLength": 3,
					"description": "The name of the customer"
				},
				{
					"name": "storeOrderNumber",
					"type": "text",
					"label": "Store Order Number",
					"required": true,
					"description": "The order number associated with the store"
				},
				{
					"name": "buildNumber",
					"type": "text",
					"label": "Build Number",
					"required": true,
					"description": "The unique identifier for the build",
					"pattern": "^\\d{4,6}$",
					"patternDescription": "Build number must be 4-6 digits"
				},
				{
					"name": "bodySource",
					"type": "select",
					"label": "Body Source",
					"required": true,
					"options": [
						{ "value": "DONOR", "label": "Donor" },
						{ "value": "CUSTOM", "label": "RS Custom" }
					],
					"description": "Source of this microphone body"
				},
				{
					"name": "microphoneCategory",
					"type": "select",
					"label": "Microphone Category",
					"required": true,
					"options": [
						{ "value": "LDC" },
						{ "value": "SDC"}
					],
					"description": "Category of the microphone"
				}
			]
		},


		"ldcCircuitryTypeDecision" : {
			"name": "Conditional for LDC Circuitry Type",
			"type": "switch",
			"expression": "a:ldcFacts.v:circuitryType",
			"cases": {
				"TL": "a:tlSequence",
				"TC": "a:tcSequence"
			}
		},

		"tlSequence" : {
			"name": "TL Circuitry Sequence",
			"description": "TL Circuitry Sequence Branch",
			"type": "sequence",
			"activities": [
				"a:tlCircuitryFacts"
			]
		},

		"tcSequence" : {
			"name": "TC Circuitry Sequence",
			"description": "TC Circuitry Sequence Branch",
			"type": "sequence",
			"activities": [
				"a:tcCircuitryFacts",
				"a:tcValidation"
			]
		},

		"micTypeDecision": {
			"name": "Conditional for LDC/SDC",
			"type": "switch",
			"expression": "a:commonFacts.v:microphoneCategory",
			"cases": {
				"LDC": "a:ldcMic",
				"SDC": "a:sdcMic"
			}
		},

		"ldcMic": {
			"name": "LDC Mic Sequence",
			"description": "LDC Mic Sequence Branch",
			"type": "sequence",
			"activities": [
				"a:ldcBodyCondition",
				"a:ldcFacts",
				"a:ldcCircuitryTypeDecision"
			]
		},

		"sdcMic": {
			"name": "SDC Mic Sequence",
			"description": "SDC Mic Sequence Branch",
			"type": "sequence",
			"activities": []
		},

		"ldcBodyCondition": {
			"name": "Conditional for LDC Body Source",
			"type": "switch",
			"expression": "a:commonFacts.v:bodySource",
			"cases": {
				"DONOR": "a:ldcDonorFacts",
				"CUSTOM": "a:ldcCustomBodyFacts"
			}
		},

		"ldcDonorFacts" : {
			"name": "LDC Donor Facts",
			"description": "Collect Data Regarding LDC Donor Type",
			"type": "human",
			"inputs": [
				{
					"name": "donor",
					"type": "select",
					"label": "Donor Body Style",
					"required": true,
					"options": [
						{"value": "990", "label": "990"},
						{"value": "990S", "label": "990S"},
						{"value": "770", "label": "770"},
						{"value": "NOVA", "label": "Nova"},
						{"value": "ST55", "label": "ST55"},
						{"value": "910", "label": "910"},
						{"value": "920", "label": "920"},
						{"value": "OTHER", "label": "Other (800-ish)"}
					]
				}
			]
		},

		"ldcCustomBodyFacts" : {
			"name": "LDC Custom Body Facts",
			"description": "Collect Data Regarding LDC Custom Body Type",
			"type": "human",
			"inputs": [
				{
					"name": "body",
					"type": "select",
					"label": "Body Style",
					"required": true,
					"options": [
						{"value": "102", "label": "102"},
						{"value": "TF33", "label": "TF33"},
						{"value": "OTHER", "label": "Other (800-ish)"}
					]
				}
			]
		},

		"ldcCustomMicFacts" : {
			"name": "LDC Custom Mic Facts",
			"description": "Collect Data Regarding LDC Custom Mic Type",
			"type": "human",
			"inputs": [
				{
					"name": "body",
					"type": "select",
					"label": "Body Style",
					"required": true,
					"options": [
						{"value": "102", "label": "102"},
						{"value": "TF33", "label": "TF33"},
						{"value": "OTHER", "label": "Other (800-ish)"}
					]
				}
			]
		},

		"tlCircuitryFacts" : {
			"name" : "TL Circuit Data",
			"description" : "Transformerless Circuit Data Collection",
			"type" : "human",
			"inputs" : [
				{
					"name" : "vcc",
					"label" : "Vcc Voltage",
					"type" : "number",
					"required" : true,
					"min" : 5,
					"max" : 12
				},
				{
					"name" : "pol",
					"label" : "Capsule pol+ Voltage",
					"type" : "number",
					"required" : true,
					"min" : 55,
					"max"	: 65
				},
				{
					"name" : "vs",
					"label" : "Vs FET Source Voltage",
					"type" : "number",
					"required" : true,
					"min" : 1,
					"max"	: 10
				}
			]
		},

		"tcCircuitryFacts" : {
			"name":"TC Data Collection",
			"description":"Transformer Coupled Circuit Data Collection",
			"type": "human",
			"inputs": [{
					"name" : "r3-pot",
					"label" : "R3 Pot Value (K Ohm)",
					"hint": "Value of R3 Pot for Minimum THD",
					"type" : "number",
					"required" : true,
					"min" : 2,
					"max" : 10
				},
				{
					"name" : "r3-actual",
					"label" : "R3 Actual Value (K Ohm)",
					"hint": "Closest Selected Fixed Resistor for R3",
					"type" : "number",
					"required" : true,
					"min" : 2,
					"max"	: 10
				}
			]
		},

		"testing" : {
			"name":"Testing",
			"description" : "Testing Sequence",
			"type": "sequence",
			"activities": [

			]
		},

		"electricalInspection" : {
			"type" : "human",
			"name" : "Electrical Inspection",
			"inputs" : [
				{
					"name" : "pcb",
					"label" : "PCB Soldering Neat and Clean",
					"type" : "boolean",
					"required" : true
				},
				{
					"name" : "capsule",
					"label" : "Capsule Soldering Neat and Clean",
					"type" : "boolean",
					"required" : true
				},
				{
					"name" : "xlr",
					"label" : "XLR Wiring and Pins Inspection",
					"type" : "boolean",
					"required" : true
				}
			]
		},

		"visualInspectionSequence" : {
			"name" : "Visual Inspection Sequence",
			"type" : "sequence",
			"activities" : [
				"a:visualInspection",
				"a:visualInspectionValidation"
			]
		},

		"visualInspection" : {
			"type":"human",
			"name":"Visual Inspection",
			"inputs" : [
				{
					"name" : "finish",
					"label" : "Body Finish",
					"type" : "boolean",
					"required" : true
				},
				{
					"name" : "engraving",
					"label" : "Engraving Clean and Correct",
					"type" : "boolean",
					"required" : true
				},
				{
					"name":"headbasket",
					"label":"Headbasket Clean and Neat",
					"type":"boolean",
					"required":true
				}
			]
		},

		"visualInspectionValidation" : {
			"type":"compute",
			"name":"Visual Inspection Validation",
			"code": [
				"a:visualInspectionValidation.passFail = a:visualInspection.v:finish && a:visualInspection.v:engraving && a:visualInspection.v:headbasket ? 'pass' : 'fail';"
			]
		},

		"mechanicalInspection" : {
			"name" : "Mechanical Inspection",
			"type" : "human",
			"description" : "Mountings, Fasteners, Clearance...",
			"inputs" :[
				{
					"name" : "mountings",
					"label" : "Mountings and Fasteners",
					"type" : "boolean",
					"required" : true
				},
				{
					"name" : "clearance",
					"label" : "Clearance",
					"type" : "boolean",
					"required" : true
				}
			]
		},

		"tcValidation" : {
			"name":"TC Data Validation",
			"description" : "Transformer Coupled Data Validation",
			"type": "compute",
			"code": [
				"const r3Pot = a:tcCircuitryFacts.v:r3-pot;",
				"const r3Actual = a:tcCircuitryFacts.v:r3-actual;",
				"const deviation = Math.abs(r3Actual - r3Pot)/r3Pot;",
				"a:tcValidation.passFail = deviation < 0.05 ? 'pass' : 'fail';"
			]
		},

		"ldcFacts": {
			"name": "LDC Facts Sequence",
			"description": "LDC Facts Sequence Branch",
			"type": "human",
			"inputs": [
				{
					"name": "circuitryType",
					"type": "select",
					"label": "Circuitry Type",
					"required": true,
					"options": [
						{
							"value": "TL",
							"label": "Transformerless"
						},
						{
							"value": "TC",
							"label": "Transformer Coupled"
						}
					]
				},
				{
					"name": "capsule",
					"type": "select",
					"label": "Capsule",
					"required": true,
					"options": [
						{
							"value": "K47",
							"label": "K47-Style (getwin)"
						},
						{
							"value": "CK12",
							"label": "CK12-Style (getwin)"
						}
					]
				}
			]
		},


		"transformerFacts": {
			"name": "Transformer Facts",
			"description": "Collect Data Regarding Transformer Type",
			"type": "human",
			"inputs": [
				{
					"name": "transformer",
					"type": "select",
					"label": "Transformer",
					"required": true,
					"options": [
						{ "value":"Cinemag 5722w"},
						{ "value":"AMI T12"},
						{ "value":"3U Audio GZT-84"},
						{ "value":"Neutrik (lo-fi)"},
						{ "value":"Other"}
					]
				}
			]
		},


		"validateCommonFacts": {
			"name": "Validate Common Facts",
			"description": "Ensure all common facts are correctly provided",
			"type": "compute",
			"code": [
				"// Retrieve common facts from the previous activity",
				"const buildNumber = a:commonFacts.v:buildNumber;",
				"// Check if build number exists and is valid",
				"a:validateCommonFacts.passFail = buildNumber ? 'pass' : 'fail';"
			]
		},

		"generateTitle": {
			"name": "Generate Title",
			"description": "Generate a title for the build based on common facts",
			"type": "compute",
			"code": [
				"// Retrieve common facts from the previous activity",
				"const customerName = a:commonFacts.v:customerName;",
				"const buildNumber = a:commonFacts.v:buildNumber;",
				"const microphoneCategory = a:commonFacts.v:microphoneCategory;",
				"const title = `${customerName}-${buildNumber}-${microphoneCategory}`;",
				"v:title = title;"
			]
		}
	}
}